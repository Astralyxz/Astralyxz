<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wargame Estrat√©gico - Astralyxz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; color: #343a40; }
        .tab-button.active { background-color: #2563eb; color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2), 0 2px 4px -2px rgba(37, 99, 235, 0.1); }
        .content-pane { display: none; }
        .content-pane.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .chart-container { position: relative; width: 100%; height: 400px; max-height: 50vh; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #2563eb; cursor: pointer; border-radius: 50%; }
        .dark input[type="range"] { background: #475569; }
        .param-section h4 { font-weight: 600; color: #cbd5e1; font-size: 1.1rem; border-bottom: 1px solid #475569; padding-bottom: 0.5rem; margin-bottom: 1rem;}
        .btn { padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; transition: all 0.2s; }
        .btn-primary { background-color: #2563eb; color: white; }
        .btn-primary:hover { background-color: #1d4ed8; }
        .btn-secondary { background-color: #475569; color: #e2e8f0; }
        .btn-secondary:hover { background-color: #64748b; }
        .btn-export { background-color: #059669; color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem; }
        .btn-export:hover { background-color: #047857; }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800">TE AMO LARA!!</h1>
            <p class="text-xl text-teal-700 mt-2 font-medium">Wargame de Simulaci√≥n Estrat√©gica Astralyxz</p>
        </header>
        
        <section id="advanced_simulator_section" class="bg-slate-800 text-white p-6 md:p-8 rounded-xl shadow-2xl dark">
            <h2 class="text-3xl font-bold text-white mb-6 text-center">Cuarto de Guerra Estrat√©gico</h2>
            <div class="bg-white/10 rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-bold text-white mb-6 text-center">Palancas de Mando</h3>
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-x-8 gap-y-6">
                    <!-- Crecimiento -->
                    <div class="space-y-4 lg:border-r lg:border-slate-700 lg:pr-6 param-section">
                        <h4>Crecimiento y Adquisici√≥n</h4>
                        <div><label for="initialUsers" class="text-sm">Usuarios Iniciales</label><input type="range" id="initialUsers" min="100" max="5000" value="1000" step="100"><span id="initialUsersValue" class="float-right"></span></div>
                        <div><label for="marketingBudget" class="text-sm">Inversi√≥n Marketing Mensual (CLP)</label><input type="range" id="marketingBudget" min="0" max="10000000" value="1000000" step="250000"><span id="marketingBudgetValue" class="float-right"></span></div>
                        <div><label for="cpaPaid" class="text-sm">CPA - Marketing Pagado (CLP)</label><input type="range" id="cpaPaid" min="400" max="5000" value="1200"><span id="cpaPaidValue" class="float-right"></span></div>
                        <div><label for="invitesPerUser" class="text-sm">Invitaciones por Usuario / Mes</label><input type="range" id="invitesPerUser" min="0.1" max="10" step="0.1" value="2"><span id="invitesPerUserValue" class="float-right"></span></div>
                        <div><label for="conversionRate" class="text-sm">Tasa Conversi√≥n Invitados (%)</label><input type="range" id="conversionRate" min="1" max="50" value="15"><span id="conversionRateValue" class="float-right"></span></div>
                    </div>
                    <!-- Cohortes -->
                    <div class="space-y-4 lg:border-r lg:border-slate-700 lg:pr-6 param-section">
                        <h4>Segmentaci√≥n de Usuarios</h4>
                        <div><label for="whale_percent" class="text-sm">Ballenas (%)</label><input type="range" id="whale_percent" min="1" max="30" value="5"><span id="whale_percentValue" class="float-right"></span></div>
                        <div><label for="whale_arpu" class="text-sm">ARPU Ballenas (CLP)</label><input type="range" id="whale_arpu" min="10000" max="100000" value="40000" step="1000"><span id="whale_arpuValue" class="float-right"></span></div>
                        <div><label for="dolphin_percent" class="text-sm">Delfines (%)</label><input type="range" id="dolphin_percent" min="10" max="80" value="25"><span id="dolphin_percentValue" class="float-right"></span></div>
                        <div><label for="dolphin_arpu" class="text-sm">ARPU Delfines (CLP)</label><input type="range" id="dolphin_arpu" min="5000" max="40000" value="15000" step="500"><span id="dolphin_arpuValue" class="float-right"></span></div>
                        <div><label class="text-sm">Pececillos (%)</label><span id="minnow_percentValue" class="float-right font-bold"></span></div>
                         <div><label for="minnow_arpu" class="text-sm">ARPU Pececillos (CLP)</label><input type="range" id="minnow_arpu" min="1000" max="10000" value="3000" step="500"><span id="minnow_arpuValue" class="float-right"></span></div>
                    </div>
                    <!-- Finanzas -->
                    <div class="space-y-4 lg:border-r lg:border-slate-700 lg:pr-6 param-section">
                        <h4>Finanzas y Operaciones</h4>
                        <div><label for="opex" class="text-sm">Costos Operativos Mensuales (CLP)</label><input type="range" id="opex" min="500000" max="20000000" value="2000000" step="250000"><span id="opexValue" class="float-right"></span></div>
                        <div><label for="raffleMargin" class="text-sm">Margen Objetivo de Rifas (%)</label><input type="range" id="raffleMargin" min="20" max="95" value="85"><span id="raffleMarginValue" class="float-right"></span></div>
                        <div><label for="marketplaceMargin" class="text-sm">Margen del Marketplace (%)</label><input type="range" id="marketplaceMargin" min="10" max="60" value="35"><span id="marketplaceMarginValue" class="float-right"></span></div>
                        <div><label for="redemptionRate" class="text-sm">Tasa de Canje de Premios (%)</label><input type="range" id="redemptionRate" min="50" max="100" value="80"><span id="redemptionRateValue" class="float-right"></span></div>
                        <div><label for="churnRate" class="text-sm">Tasa de Abandono Mensual (%)</label><input type="range" id="churnRate" min="1" max="40" value="10"><span id="churnRateValue" class="float-right"></span></div>
                    </div>
                    <!-- Banco Central -->
                    <div class="space-y-4 param-section">
                        <h4>Gobernanza Econ√≥mica</h4>
                        <div class="flex items-center justify-between"><label for="governor_enabled" class="text-sm">Activar Banco Central</label><input type="checkbox" id="governor_enabled" class="form-checkbox h-5 w-5 text-blue-600 rounded" checked></div>
                        <div><label for="inflation_target" class="text-sm">Inflaci√≥n Objetivo Mensual (%)</label><input type="range" id="inflation_target" min="2" max="25" value="8"><span id="inflation_targetValue" class="float-right"></span></div>
                        <div><label for="seguroRate" class="text-sm">Tasa Adopci√≥n "Seguro" (%)</label><input type="range" id="seguroRate" min="0" max="60" value="15"><span id="seguroRateValue" class="float-right"></span></div>
                         <div><label for="simulationMonths" class="text-sm">Meses a Simular</label><input type="range" id="simulationMonths" min="12" max="48" value="12"><span id="simulationMonthsValue" class="float-right"></span></div>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mt-8">
                    <button id="run-simulation" class="btn btn-primary w-full sm:w-auto">Ejecutar Simulaci√≥n</button>
                    <button id="save-scenario" class="btn btn-secondary w-full sm:w-auto">Guardar Escenario</button>
                    <button id="load-scenario" class="btn btn-secondary w-full sm:w-auto">Cargar Escenario</button>
                </div>
            </div>

            <div class="bg-slate-900/50 rounded-xl shadow-lg p-4 sm:p-6">
                <div class="border-b border-slate-700 pb-2">
                    <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                        <button class="tab-button active py-3 px-4 font-medium text-sm" data-tab="summary">Resumen Ejecutivo</button>
                        <button class="tab-button text-slate-300 hover:bg-slate-700/50 py-3 px-4 font-medium text-sm" data-tab="banco_central">Gobernanza</button>
                        <button class="tab-button text-slate-300 hover:bg-slate-700/50 py-3 px-4 font-medium text-sm" data-tab="users">Usuarios</button>
                        <button class="tab-button text-slate-300 hover:bg-slate-700/50 py-3 px-4 font-medium text-sm" data-tab="cohorts">Cohortes</button>
                        <button class="tab-button text-slate-300 hover:bg-slate-700/50 py-3 px-4 font-medium text-sm" data-tab="ac_economy">Econom√≠a AC</button>
                        <button class="tab-button text-slate-300 hover:bg-slate-700/50 py-3 px-4 font-medium text-sm" data-tab="marketplace">Marketplace</button>
                        <button class="tab-button text-slate-300 hover:bg-slate-700/50 py-3 px-4 font-medium text-sm" data-tab="finance">Finanzas CLP</button>
                    </nav>
                </div>
                <div class="pt-6">
                    <div id="summary" class="content-pane active"></div>
                    <div id="banco_central" class="content-pane"></div>
                    <div id="users" class="content-pane"></div>
                    <div id="cohorts" class="content-pane"></div>
                    <div id="ac_economy" class="content-pane"></div>
                    <div id="marketplace" class="content-pane"></div>
                    <div id="finance" class="content-pane"></div>
                </div>
            </div>
        </section>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const businessSimulator = {
            charts: {},
            init() {
                this.setupSliders();
                this.setupTabs();
                document.getElementById('run-simulation').addEventListener('click', () => this.run());
                document.getElementById('save-scenario').addEventListener('click', () => this.saveScenario());
                document.getElementById('load-scenario').addEventListener('click', () => this.loadScenario());
                this.run();
            },
            setupSliders() {
                this.sliders = {
                    initialUsers: document.getElementById('initialUsers'), marketingBudget: document.getElementById('marketingBudget'), cpaPaid: document.getElementById('cpaPaid'), invitesPerUser: document.getElementById('invitesPerUser'), conversionRate: document.getElementById('conversionRate'),
                    whale_percent: document.getElementById('whale_percent'), whale_arpu: document.getElementById('whale_arpu'), dolphin_percent: document.getElementById('dolphin_percent'), dolphin_arpu: document.getElementById('dolphin_arpu'), minnow_arpu: document.getElementById('minnow_arpu'),
                    opex: document.getElementById('opex'), raffleMargin: document.getElementById('raffleMargin'), marketplaceMargin: document.getElementById('marketplaceMargin'), redemptionRate: document.getElementById('redemptionRate'), churnRate: document.getElementById('churnRate'),
                    governor_enabled: document.getElementById('governor_enabled'), inflation_target: document.getElementById('inflation_target'), seguroRate: document.getElementById('seguroRate'), simulationMonths: document.getElementById('simulationMonths')
                };
                Object.values(this.sliders).forEach(slider => {
                    if(slider.type === 'range') slider.addEventListener('input', () => this.updateSliderDisplay());
                });
                this.updateSliderDisplay();
            },
            updateSliderDisplay() {
                Object.entries(this.sliders).forEach(([key, slider]) => {
                    if (slider.type !== 'range') return;
                    const display = document.getElementById(`${key}Value`);
                    if (!display) return;
                    let value = parseFloat(slider.value);
                    let text = this.formatNumber(value);

                    const whalePercent = parseFloat(this.sliders.whale_percent.value);
                    const dolphinPercent = parseFloat(this.sliders.dolphin_percent.value);
                    const minnowPercent = 100 - whalePercent - dolphinPercent;
                    if(document.getElementById('minnow_percentValue')) document.getElementById('minnow_percentValue').textContent = `${minnowPercent.toFixed(0)}%`;

                    if (['marketingBudget', 'cpaPaid', 'whale_arpu', 'dolphin_arpu', 'minnow_arpu', 'opex'].includes(key)) text = this.formatNumber(value, '$');
                    if (['conversionRate', 'churnRate', 'seguroRate', 'raffleMargin', 'marketplaceMargin', 'redemptionRate', 'whale_percent', 'dolphin_percent', 'inflation_target'].includes(key)) text = `${value}%`;
                    if (key === 'invitesPerUser') text = value.toFixed(1);
                    display.textContent = text;
                });
            },
            formatNumber: (num, prefix = '', suffix = '') => `${prefix}${new Intl.NumberFormat('es-CL').format(Math.round(num))}${suffix}`,
            
            run() {
                const P = {
                    initialUsers: parseInt(this.sliders.initialUsers.value),
                    marketingBudget: parseInt(this.sliders.marketingBudget.value),
                    cpaPaid: parseInt(this.sliders.cpaPaid.value),
                    invitesPerUser: parseFloat(this.sliders.invitesPerUser.value),
                    conversionRate: parseFloat(this.sliders.conversionRate.value) / 100,
                    churnRate: parseFloat(this.sliders.churnRate.value) / 100,
                    seguroRate: parseFloat(this.sliders.seguroRate.value) / 100,
                    raffleMargin: parseFloat(this.sliders.raffleMargin.value) / 100,
                    marketplaceMargin: parseFloat(this.sliders.marketplaceMargin.value) / 100,
                    redemptionRate: parseFloat(this.sliders.redemptionRate.value) / 100,
                    opex: parseInt(this.sliders.opex.value),
                    simulationMonths: parseInt(this.sliders.simulationMonths.value),
                    governor_enabled: this.sliders.governor_enabled.checked,
                    inflation_target: parseFloat(this.sliders.inflation_target.value) / 100,
                    cohorts: {
                        whale: { pct: parseFloat(this.sliders.whale_percent.value) / 100, arpu: parseInt(this.sliders.whale_arpu.value) },
                        dolphin: { pct: parseFloat(this.sliders.dolphin_percent.value) / 100, arpu: parseInt(this.sliders.dolphin_arpu.value) },
                        minnow: { pct: (100 - parseFloat(this.sliders.whale_percent.value) - parseFloat(this.sliders.dolphin_percent.value)) / 100, arpu: parseInt(this.sliders.minnow_arpu.value) }
                    },
                    seguroPrice: 990, acToCLP: 100, cashbackRate: 0.30, 
                    baseReferralCostAC: 5, baseReferredBonusAC: 5
                };
                P.kFactor = P.invitesPerUser * P.conversionRate;
                P.avgArpu = (P.cohorts.whale.pct * P.cohorts.whale.arpu) + (P.cohorts.dolphin.pct * P.cohorts.dolphin.arpu) + (P.cohorts.minnow.pct * P.cohorts.minnow.arpu);

                let monthlyResults = [];
                let activeUsers = P.initialUsers;
                let circulatingAC = P.initialUsers * 20; 
                let treasuryCLP = 0;
                let governorLog = [];
                let currentReferralBonus = P.baseReferredBonusAC;

                for (let m = 1; m <= P.simulationMonths; m++) {
                    if (P.governor_enabled && m > 1) {
                        const lastMonthInflation = monthlyResults[m-2].inflation;
                        if (lastMonthInflation > P.inflation_target * 100) {
                            currentReferralBonus = Math.max(1, currentReferralBonus * 0.9);
                            governorLog.push({month: m, action: `Inflaci√≥n alta. Bonus de referido reducido a ${currentReferralBonus.toFixed(1)} AC.`});
                        } else {
                            currentReferralBonus = Math.min(P.baseReferredBonusAC, currentReferralBonus * 1.05);
                        }
                    }

                    const startOfMonthUsers = activeUsers;
                    const usersLostToChurn = activeUsers * P.churnRate;
                    const newPaidUsers = P.marketingBudget > 0 ? P.marketingBudget / P.cpaPaid : 0;
                    const newViralUsers = activeUsers * P.kFactor;
                    
                    const costReferralsCLP = newViralUsers * (P.baseReferralCostAC + currentReferralBonus) * P.acToCLP;
                    const totalAcquisitionCosts = P.marketingBudget + costReferralsCLP;
                    
                    const revenueCoinsCLP = activeUsers * P.avgArpu;
                    const revenueSeguroCLP = activeUsers * P.seguroRate * P.seguroPrice;
                    const totalRevenueCLP = revenueCoinsCLP + revenueSeguroCLP;
                    
                    const acIssuedPurchases = revenueCoinsCLP / P.acToCLP;
                    const acSpentInRaffles = (activeUsers * P.avgArpu) / P.acToCLP;
                    const acIssuedCashback = acSpentInRaffles * P.cashbackRate;
                    const acIssuedReferrals = newViralUsers * (P.baseReferralCostAC + currentReferralBonus);
                    const totalEmitted = acIssuedPurchases + acIssuedCashback + acIssuedReferrals;

                    const acPrizePool = acSpentInRaffles * (1 - P.raffleMargin);
                    const acRedeemedFromPrizes = acPrizePool * P.redemptionRate;
                    
                    const cogsMarketplaceCLP = acRedeemedFromPrizes * P.acToCLP * (1 - P.marketplaceMargin);
                    const finalTotalCosts = totalAcquisitionCosts + P.opex + cogsMarketplaceCLP;
                    const netProfitCLP = totalRevenueCLP - finalTotalCosts;
                    treasuryCLP += netProfitCLP;
                    
                    const lastCirculatingAC = circulatingAC;
                    circulatingAC += totalEmitted - acSpentInRaffles;
                    const inflation = lastCirculatingAC > 0 ? (circulatingAC - lastCirculatingAC) / lastCirculatingAC * 100 : 0;
                    
                    activeUsers += newPaidUsers + newViralUsers - usersLostToChurn;
                    if (activeUsers < 1) activeUsers = 1;

                    const totalNewUsers = newPaidUsers + newViralUsers;
                    const blendedCAC = totalNewUsers > 0 ? totalAcquisitionCosts / totalNewUsers : 0;
                    
                    monthlyResults.push({
                        month: m, startUsers: startOfMonthUsers, newPaid: newPaidUsers, newViral: newViralUsers, lostChurn: usersLostToChurn, endUsers: activeUsers,
                        emitted: totalEmitted, spent: acSpentInRaffles, absorbed: acRedeemedFromPrizes, circulating: circulatingAC, inflation,
                        incomeCLP: totalRevenueCLP, costsCLP: finalTotalCosts, netProfitCLP, treasuryCLP, blendedCAC,
                        marketplaceRevenueCLP: acRedeemedFromPrizes * P.acToCLP, marketplaceCogsCLP: cogsMarketplaceCLP, marketplaceProfitCLP: (acRedeemedFromPrizes * P.acToCLP) - cogsMarketplaceCLP,
                        cohorts: {
                            whale: {count: activeUsers * P.cohorts.whale.pct, revenue: activeUsers * P.cohorts.whale.pct * P.cohorts.whale.arpu},
                            dolphin: {count: activeUsers * P.cohorts.dolphin.pct, revenue: activeUsers * P.cohorts.dolphin.pct * P.cohorts.dolphin.arpu},
                            minnow: {count: activeUsers * P.cohorts.minnow.pct, revenue: activeUsers * P.cohorts.minnow.pct * P.cohorts.minnow.arpu},
                        }
                    });
                }
                this.updateUI(monthlyResults, governorLog, P);
            },
            
            updateUI(results, governorLog, params) {
                this.updateSummary(results, params);
                this.updateBancoCentral(results, governorLog);
                this.updateUsers(results);
                this.updateCohorts(results, params);
                this.updateAcEconomy(results);
                this.updateMarketplace(results);
                this.updateFinance(results);
            },
            updateSummary(results, params) { 
                const final = results[results.length - 1];
                const totalRevenue = results.reduce((sum, r) => sum + r.incomeCLP, 0);
                const totalCosts = results.reduce((sum, r) => sum + r.costsCLP, 0);
                const totalUsers = final.endUsers - params.initialUsers;
                const LTV = params.churnRate > 0 ? (params.avgArpu * (1 - params.churnRate)) / params.churnRate : Infinity;
                const overallCAC = totalUsers > 0 ? (results.reduce((sum,r) => sum + r.costsCLP - r.marketplaceCogsCLP - params.opex , 0)) / totalUsers : 0;
                const ltvCacRatio = overallCAC > 0 ? LTV / overallCAC : Infinity;
                
                let html = `<div class="p-4 bg-slate-800/50 rounded-lg"><h4 class="font-semibold text-slate-200">Resultados Clave (Anual)</h4><div class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <p><strong>Usuarios Finales:</strong> ${this.formatNumber(final.endUsers)}</p>
                    <p><strong>Tesorer√≠a Final:</strong> <span class="${final.treasuryCLP < 0 ? 'text-red-400' : 'text-green-400'}">${this.formatNumber(final.treasuryCLP, '$')}</span></p>
                    <p><strong>CAC Combinado:</strong> ${this.formatNumber(overallCAC, '$')}</p>
                    <p><strong>Ratio LTV/CAC:</strong> <span class="${ltvCacRatio < 3 ? 'text-amber-400' : 'text-green-400'}">${ltvCacRatio.toFixed(2)}</span></p>
                </div></div>`;
                
                const inflationAlerts = results.filter(r => r.inflation > 25);
                const cashflowAlerts = results.filter(r => r.netProfitCLP < 0);
                if (inflationAlerts.length > 0) html += `<div class="mt-4 p-4 bg-amber-900/50 border-l-4 border-amber-500 rounded-r-lg"><h4 class="font-semibold text-amber-300">‚ö†Ô∏è Alerta de Inflaci√≥n</h4><p class="text-sm text-amber-400 mt-1">Crecimiento monetario sobre 25% en meses: <strong>${inflationAlerts.map(a => a.month).join(', ')}</strong>.</p></div>`;
                if (cashflowAlerts.length > 0) html += `<div class="mt-4 p-4 bg-red-900/50 border-l-4 border-red-500 rounded-r-lg"><h4 class="font-semibold text-red-300">üö® Alerta de Flujo de Caja</h4><p class="text-sm text-red-400 mt-1">Flujo de caja negativo en meses: <strong>${cashflowAlerts.map(a => a.month).join(', ')}</strong>.</p></div>`;
                if (ltvCacRatio < 3 && ltvCacRatio !== Infinity) html += `<div class="mt-4 p-4 bg-amber-900/50 border-l-4 border-amber-500 rounded-r-lg"><h4 class="font-semibold text-amber-300">‚ö†Ô∏è Alerta de Rentabilidad</h4><p class="text-sm text-amber-400 mt-1">El ratio LTV/CAC es menor a 3. El costo de adquirir usuarios es demasiado alto para su valor a largo plazo.</p></div>`;
                if (inflationAlerts.length === 0 && cashflowAlerts.length === 0 && (ltvCacRatio >= 3 || ltvCacRatio === Infinity)) html += `<div class="mt-4 p-4 bg-green-900/50 border-l-4 border-green-500 rounded-r-lg"><h4 class="font-semibold text-green-300">‚úÖ Modelo Sostenible</h4><p class="text-sm text-green-400 mt-1">La econom√≠a y las finanzas son estables y rentables.</p></div>`;
                
                document.getElementById('summary').innerHTML = html;
            },
            updateBancoCentral(results, governorLog) { /* ... no changes ... */ 
                const avgInflation = results.reduce((acc, r) => acc + r.inflation, 0) / results.length;
                 const velocity = results.reduce((acc, r) => acc + r.spent, 0) / results.reduce((acc, r) => acc + r.circulating, 0);
                 const absorptionRatio = (results.reduce((a,r)=>a+r.absorbed,0) / results.reduce((a,r)=>a+r.emitted,0) * 100 || 0);
                 let logHtml = governorLog.length > 0 ? governorLog.map(l => `<li class="text-xs"><strong>Mes ${l.month}:</strong> ${l.action}</li>`).join('') : '<li class="text-xs text-slate-400">No se requirieron intervenciones.</li>';

                let html = `<div class="space-y-4"><h3 class="text-lg font-semibold text-white">Panel de Gobernanza Econ√≥mica</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="p-3 bg-slate-800/50 rounded-lg"><div class="font-bold text-blue-400">Inflaci√≥n Promedio</div><div class="text-2xl font-bold">${avgInflation.toFixed(2)}%</div></div>
                        <div class="p-3 bg-slate-800/50 rounded-lg"><div class="font-bold text-blue-400">Velocidad Moneda</div><div class="text-2xl font-bold">${(velocity || 0).toFixed(2)}</div></div>
                        <div class="p-3 bg-slate-800/50 rounded-lg"><div class="font-bold text-blue-400">Ratio Absorci√≥n</div><div class="text-2xl font-bold">${absorptionRatio.toFixed(1)}%</div></div>
                    </div>
                    <div><h4 class="font-semibold text-slate-300 mb-2">Bit√°cora del Banco Central:</h4><ul class="space-y-1 bg-slate-900/70 p-3 rounded-md">${logHtml}</ul></div>
                </div>`;
                document.getElementById('banco_central').innerHTML = html;
            },
            updateUsers(results) { /* ... no changes ... */ 
                 this.renderTableAndChart(
                    document.getElementById('users'), 'adv_users_chart', 'An√°lisis de Crecimiento de Usuarios',
                    ['Mes', 'Inicio Mes', 'Nuevos (Pagado)', 'Nuevos (Viral)', 'Perdidos (Churn)', 'Final Mes'],
                    results.map(res => [
                        res.month, this.formatNumber(res.startUsers),
                        `<span class="text-teal-400">+${this.formatNumber(res.newPaid)}</span>`,
                        `<span class="text-green-400">+${this.formatNumber(res.newViral)}</span>`,
                        `<span class="text-red-400">-${this.formatNumber(res.lostChurn)}</span>`,
                        `<span class="font-bold">${this.formatNumber(res.endUsers)}</span>`,
                    ]),
                    {
                        labels: results.map(r => `Mes ${r.month}`),
                        datasets: [
                            { label: 'Usuarios Totales', data: results.map(r => r.endUsers), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.2, fill: true, type: 'line' },
                            { label: 'Nuevos Virales', data: results.map(r => r.newViral), backgroundColor: 'rgba(34, 197, 94, 0.7)'},
                            { label: 'Nuevos Pagados', data: results.map(r => r.newPaid), backgroundColor: 'rgba(245, 158, 11, 0.7)'}
                        ]
                    },
                    { y: { stacked: true, title: { text: 'Usuarios' } } }
                );
            },
            updateCohorts(results, params) { /* ... no changes ... */ 
                const final = results[results.length-1];
                 this.renderTableAndChart(
                    document.getElementById('cohorts'), 'adv_cohorts_chart', 'An√°lisis de Cohortes de Usuarios (Mes Final)',
                    ['Cohorte', 'Usuarios', '% del Total', 'Ingreso Mensual', '% del Ingreso'],
                    [
                        ['Ballenas', `<span class="font-bold text-teal-300">${this.formatNumber(final.cohorts.whale.count)}</span>`, `${(params.cohorts.whale.pct*100).toFixed(0)}%`, this.formatNumber(final.cohorts.whale.revenue, '$'), `${(final.cohorts.whale.revenue / final.incomeCLP * 100 || 0).toFixed(0)}%`],
                        ['Delfines', `<span class="font-bold text-blue-300">${this.formatNumber(final.cohorts.dolphin.count)}</span>`, `${(params.cohorts.dolphin.pct*100).toFixed(0)}%`, this.formatNumber(final.cohorts.dolphin.revenue, '$'), `${(final.cohorts.dolphin.revenue / final.incomeCLP * 100 || 0).toFixed(0)}%`],
                        ['Pececillos', `<span class="font-bold text-slate-300">${this.formatNumber(final.cohorts.minnow.count)}</span>`, `${(params.cohorts.minnow.pct*100).toFixed(0)}%`, this.formatNumber(final.cohorts.minnow.revenue, '$'), `${(final.cohorts.minnow.revenue / final.incomeCLP * 100 || 0).toFixed(0)}%`],
                    ],
                    {
                        labels: ['Ballenas', 'Delfines', 'Pececillos'],
                        datasets: [
                            { label: '% de Usuarios', data: [params.cohorts.whale.pct*100, params.cohorts.dolphin.pct*100, params.cohorts.minnow.pct*100], backgroundColor: ['#0d9488', '#2563eb', '#64748b'], yAxisID: 'y' },
                            { label: '% de Ingresos', data: [(final.cohorts.whale.revenue / final.incomeCLP * 100 || 0), (final.cohorts.dolphin.revenue / final.incomeCLP * 100 || 0), (final.cohorts.minnow.revenue / final.incomeCLP * 100 || 0)], backgroundColor: ['rgba(13, 148, 136, 0.5)', 'rgba(37, 99, 235, 0.5)', 'rgba(100, 116, 139, 0.5)'], yAxisID: 'y' }
                        ]
                    },
                    { y: { max: 100, title: { text: 'Porcentaje (%)' } } }
                );
            },
            updateAcEconomy(results) { /* ... no changes ... */ 
                this.renderTableAndChart(
                    document.getElementById('ac_economy'), 'adv_ac_chart', 'Evoluci√≥n de la Econom√≠a Virtual (AC)',
                    ['Mes', 'Emitidos', 'Gastados (Rifas)', 'Absorbidos (Market)', 'Inflaci√≥n', 'Circulante Final'],
                    results.map(res => [
                        res.month, `<span class="text-green-400">+${this.formatNumber(res.emitted)}</span>`,
                        `<span class="text-red-400">-${this.formatNumber(res.spent)}</span>`,
                        `<span class="text-amber-400">-${this.formatNumber(res.absorbed)}</span>`,
                        `<span class="${res.inflation > 10 ? 'text-amber-400 font-bold' : 'text-slate-300'}">${res.inflation.toFixed(1)}%</span>`,
                        `<span class="font-bold">${this.formatNumber(res.circulating)}</span>`
                    ]),
                    {
                        labels: results.map(r => `Mes ${r.month}`),
                        datasets: [
                            { label: 'AC Circulantes', data: results.map(r => r.circulating), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.2, yAxisID: 'y', fill: true, type: 'line' },
                            { label: 'AC Emitidos', data: results.map(r => r.emitted), backgroundColor: 'rgba(34, 197, 94, 0.7)', yAxisID: 'y1', type: 'bar' },
                            { label: 'AC Gastados', data: results.map(r => r.spent), backgroundColor: 'rgba(239, 68, 68, 0.7)', yAxisID: 'y1', type: 'bar' }
                        ]
                    },
                    { y: { title: { text: 'Total AC Circulantes' } }, y1: { position: 'right', title: { text: 'Flujo Mensual de AC' }, grid: { drawOnChartArea: false }, stacked: true } }
                );
            },
            updateMarketplace(results) { /* ... no changes ... */ 
                 this.renderTableAndChart(
                    document.getElementById('marketplace'), 'adv_marketplace_chart', 'An√°lisis de Rentabilidad del Marketplace',
                    ['Mes', 'AC Gastados', 'Ventas (CLP)', 'Costo Productos (CLP)', 'Ganancia Neta (CLP)'],
                    results.map(res => [
                        res.month,
                        `<span class="text-amber-400">${this.formatNumber(res.absorbed)}</span>`,
                        this.formatNumber(res.marketplaceRevenueCLP, '$'),
                        this.formatNumber(res.marketplaceCogsCLP, '$'),
                        `<span class="font-bold ${res.marketplaceProfitCLP < 0 ? 'text-red-400' : 'text-green-400'}">${this.formatNumber(res.marketplaceProfitCLP, '$')}</span>`
                    ]),
                    {
                        labels: results.map(r => `Mes ${r.month}`),
                        datasets: [
                            { label: 'Ventas CLP', data: results.map(r => r.marketplaceRevenueCLP), backgroundColor: 'rgba(34, 197, 94, 0.7)'},
                            { label: 'Costo Productos CLP', data: results.map(r => r.marketplaceCogsCLP), backgroundColor: 'rgba(239, 68, 68, 0.7)'},
                            { label: 'Ganancia Neta CLP', data: results.map(r => r.marketplaceProfitCLP), backgroundColor: 'rgba(59, 130, 246, 0.7)'}
                        ]
                    },
                    { y: { stacked: false, title: { text: 'CLP' } } }
                );
            },
            updateFinance(results) { /* ... no changes ... */ 
                this.renderTableAndChart(
                    document.getElementById('finance'), 'adv_finance_chart', 'An√°lisis Financiero General (CLP)',
                    ['Mes', 'Ingresos', 'Costos', 'Ganancia Neta', 'Tesorer√≠a'],
                    results.map(res => [
                        res.month, `<span class="text-green-400">${this.formatNumber(res.incomeCLP, '$')}</span>`,
                        `<span class="text-amber-400">${this.formatNumber(res.costsCLP, '$')}</span>`,
                        `<span class="font-bold ${res.netProfitCLP < 0 ? 'text-red-400' : 'text-green-400'}">${this.formatNumber(res.netProfitCLP, '$')}</span>`,
                        `<span class="font-semibold ${res.treasuryCLP < 0 ? 'text-red-400' : 'text-white'}">${this.formatNumber(res.treasuryCLP, '$')}</span>`
                    ]),
                    {
                         labels: results.map(r => `Mes ${r.month}`),
                        datasets: [
                            { type: 'bar', label: 'Ingresos CLP', data: results.map(r => r.incomeCLP), backgroundColor: 'rgba(34, 197, 94, 0.7)', yAxisID: 'y' },
                            { type: 'bar', label: 'Costos CLP', data: results.map(r => r.costsCLP), backgroundColor: 'rgba(239, 68, 68, 0.7)', yAxisID: 'y' },
                            { type: 'line', label: 'Tesorer√≠a CLP', data: results.map(r => r.treasuryCLP), borderColor: '#60a5fa', tension: 0.2, yAxisID: 'y1', fill: false, borderWidth: 3 }
                        ]
                    }, 
                    { y: { title: { text: 'Flujo Mensual (CLP)' } }, y1: { position: 'right', title: { text: 'Tesorer√≠a Acumulada (CLP)' }, grid: { drawOnChartArea: false } } }
                );
            },
            renderTableAndChart(pane, canvasId, title, headers, rowsData, chartData, chartScales) {
                let canvas = pane.querySelector('canvas');
                let tableBody = pane.querySelector('tbody');
                if (!tableBody) {
                    pane.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-lg font-semibold text-white">${title}</h3><button class="btn-export btn" data-table-id="${canvasId}-table">Exportar CSV</button></div><div class="grid grid-cols-1 xl:grid-cols-2 gap-8"><div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-700 text-sm" id="${canvasId}-table"><thead class="bg-slate-800/50"><tr>${headers.map(h => `<th class="px-3 py-2 text-left text-xs font-medium text-slate-400 uppercase tracking-wider">${h}</th>`).join('')}</tr></thead><tbody class="bg-slate-900/30 divide-y divide-slate-800"></tbody></table></div><div class="chart-container"><canvas id="${canvasId}"></canvas></div></div>`;
                    canvas = document.getElementById(canvasId);
                    tableBody = pane.querySelector('tbody');
                    pane.querySelector('.btn-export').addEventListener('click', (e) => this.exportToCSV(e.target.dataset.tableId, `${title}.csv`));
                }
                
                tableBody.innerHTML = '';
                rowsData.forEach(rowData => {
                    const row = document.createElement('tr');
                    row.innerHTML = rowData.map((d, i) => `<td class="px-3 py-2 whitespace-nowrap ${i === 0 ? 'font-medium text-white' : ''}">${d}</td>`).join('');
                    tableBody.appendChild(row);
                });

                this.createOrUpdateChart(canvas, canvasId, chartData, chartScales);
            },
            createOrUpdateChart(canvas, canvasId, data, scales) {
                if (this.charts[canvasId]) { this.charts[canvasId].data = data; this.charts[canvasId].options.scales = this.getChartScales(scales); this.charts[canvasId].update(); }
                else {
                    this.charts[canvasId] = new Chart(canvas.getContext('2d'), {
                        type: 'bar', data,
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            scales: this.getChartScales(scales),
                            plugins: { legend: { labels: { color: '#cbd5e1' } }, tooltip: { mode: 'index', intersect: false, callbacks: { label: (c) => `${c.dataset.label}: ${this.formatNumber(c.parsed.y)}` } } }
                        }
                    });
                }
            },
            getChartScales(scales) {
                return { ...Object.fromEntries(Object.entries(scales).map(([k, v]) => [k, { ...v, ticks: { color: '#9ca3af' }, title: { ...v.title, display: true, color: '#9ca3af' } }])), x: { ticks: { color: '#9ca3af' }} };
            },
            setupTabs() {
                const tabs = document.querySelectorAll('#advanced_simulator_section .tab-button');
                const panes = document.querySelectorAll('#advanced_simulator_section .content-pane');
                tabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        tabs.forEach(t => t.classList.remove('active'));
                        panes.forEach(p => p.classList.remove('active'));
                        tab.classList.add('active');
                        document.getElementById(tab.dataset.tab).classList.add('active');
                    });
                });
            },
            saveScenario() {
                const scenario = {};
                Object.entries(this.sliders).forEach(([key, slider]) => {
                    scenario[key] = slider.type === 'checkbox' ? slider.checked : slider.value;
                });
                localStorage.setItem('astralyxz_wargame_scenario', JSON.stringify(scenario));
                alert('Escenario guardado con √©xito!');
            },
            loadScenario() {
                const scenario = JSON.parse(localStorage.getItem('astralyxz_wargame_scenario'));
                if (scenario) {
                    Object.entries(scenario).forEach(([key, value]) => {
                        if (this.sliders[key]) {
                            if (this.sliders[key].type === 'checkbox') this.sliders[key].checked = value;
                            else this.sliders[key].value = value;
                        }
                    });
                    this.updateSliderDisplay();
                    this.run();
                    alert('Escenario cargado con √©xito!');
                } else {
                    alert('No hay ning√∫n escenario guardado.');
                }
            },
            exportToCSV(tableId, filename) {
                let csv = [];
                const table = document.getElementById(tableId);
                const rows = table.querySelectorAll("tr");
                
                for (const row of rows) {
                    const cols = row.querySelectorAll("td, th");
                    const rowData = [];
                    for (const col of cols) {
                        // Limpiar el texto para que sea compatible con CSV
                        let data = col.innerText.replace(/(\r\n|\n|\r)/gm, "").replace(/(\s\s)/gm, " ");
                        data = data.replace(/"/g, '""'); // Escapar comillas dobles
                        rowData.push(`"${data}"`);
                    }
                    csv.push(rowData.join(","));
                }

                const csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
                const downloadLink = document.createElement("a");
                downloadLink.download = filename;
                downloadLink.href = window.URL.createObjectURL(csvFile);
                downloadLink.style.display = "none";
                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);
            }
        };
        businessSimulator.init();
    });
    </script>
</body>
</html>
