<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Simulaci√≥n de Negocios - Astralyxz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap" rel="stylesheet">
    <!-- 
        Chosen Palette: Merged (Strategic Teal & Gold + Corporate Blue & Neutral Gray)
        Application Structure Plan: This final version evolves the SPA into a complete business modeling wargame. The simulator's logic is now a feedback loop system. The "Banco Central" rules (e.g., inflation targeting) directly affect simulation parameters in subsequent months. The UI reflects this with a new "Diagn√≥stico del Banco Central" tab and more insightful executive summaries. The parameter controls are now more granular, including demand-side constraints.
        Visualization & Content Choices: The existing visualizations are preserved. The key addition is a new combo bar/line chart for the financial simulation, showing CLP Income/Costs (bars) against cumulative Treasury (line), providing a complete financial health check at a glance. The executive summary is now far more insightful, offering alerts on both virtual inflation and real-world cash flow risks.
        CONFIRMATION: NO SVG graphics used. NO Mermaid JS used.
    -->
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; color: #343a40; }
        .diagram-node, .tab-button { transition: all 0.3s ease; }
        .diagram-node:hover, .diagram-node.active { transform: scale(1.05); box-shadow: 0 0 20px rgba(17, 138, 178, 0.4); border-color: #0d9488; cursor:pointer; }
        .flow-arrow { position: relative; text-align: center; display: flex; align-items: center; justify-content: center; color: #6c757d; }
        .flow-arrow::after { content: '‚Üí'; font-size: 2.5rem; line-height: 1; }
        @media (max-width: 767px) { .flow-arrow::after { content: '‚Üì'; font-size: 2rem; } }
        .detail-panel-content, .content-pane.active { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .chart-container-economy { position: relative; width: 100%; height: 400px; max-height: 50vh; }

        input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #e2e8f0; border-radius: 5px; outline: none; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #3182ce; cursor: pointer; border-radius: 50%; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: #3182ce; cursor: pointer; border-radius: 50%; }

        .tab-button { border-radius: 0.5rem; }
        .tab-button.active { background-color: #2563eb; color: white; box-shadow: 0 4px 6px -1px rgba(37, 99, 235, 0.2), 0 2px 4px -2px rgba(37, 99, 235, 0.1); }
        .content-pane { display: none; }
        .content-pane.active { display: block; }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto px-4 py-8 md:py-12">
        <header class="text-center mb-10 md:mb-12">
            <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800">TE AMO LARA!!</h1>
            <p class="text-xl text-teal-700 mt-2 font-medium">Panel de Simulaci√≥n de Negocios Astralyxz</p>
        </header>

        <section id="economic-flow" class="mb-12">
            <h2 class="text-2xl font-bold text-center mb-4">Ciclo de Vida de la Moneda</h2>
            <p class="text-center text-gray-600 mb-8 max-w-3xl mx-auto">Este diagrama representa el flujo de valor de la Astralyxz Coin. Haz clic en cada etapa para entender su rol estrat√©gico en la econom√≠a.</p>
            <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-0">
                <div data-target="emission" class="diagram-node w-full md:w-1/4 bg-white p-4 rounded-lg shadow-md border-2 border-transparent text-center">
                    <span class="text-4xl"> üí∏ </span><h3 class="font-bold text-lg mt-2">EMISI√ìN</h3><p class="text-xs text-gray-500">Creaci√≥n de Valor</p>
                </div>
                <div class="flow-arrow w-full md:w-1/12 h-16 md:h-auto"></div>
                <div data-target="circulation" class="diagram-node w-full md:w-1/4 bg-white p-4 rounded-lg shadow-md border-2 border-transparent text-center">
                     <span class="text-4xl"> üîÑ </span><h3 class="font-bold text-lg mt-2">CIRCULACI√ìN</h3><p class="text-xs text-gray-500">Gasto y Recirculaci√≥n</p>
                </div>
                 <div class="flow-arrow w-full md:w-1/12 h-16 md:h-auto"></div>
                <div data-target="control" class="diagram-node w-full md:w-1/4 bg-white p-4 rounded-lg shadow-md border-2 border-transparent text-center">
                    <span class="text-4xl"> üõ°Ô∏è </span><h3 class="font-bold text-lg mt-2">ABSORCI√ìN</h3><p class="text-xs text-gray-500">Sumideros de Valor</p>
                </div>
            </div>
        </section>
        
        <main id="detail-panel" class="min-h-[300px] bg-white/70 p-6 md:p-8 rounded-xl shadow-lg border border-gray-200 mb-12"></main>

        <!-- === INICIO: SIMULADOR DE NEGOCIOS COMPLETO === -->
        <section id="advanced_simulator_section" class="bg-slate-800 text-white p-6 md:p-8 rounded-xl shadow-2xl mb-12">
            <h2 class="text-2xl font-bold text-white mb-2 text-center">Panel de Simulaci√≥n de Negocios (12 Meses)</h2>
            <p class="text-center text-sm text-slate-400 mb-6 max-w-3xl mx-auto">Esta es la herramienta estrat√©gica principal. Ajusta las palancas de crecimiento, econom√≠a y finanzas para modelar el futuro de la empresa, identificar riesgos y validar la sostenibilidad del negocio.</p>

            <div class="bg-white/10 rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-bold text-white mb-6 text-center">Palancas de Control Estrat√©gico</h3>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-x-8 gap-y-6">
                    <div class="space-y-4 lg:border-r lg:border-slate-700 lg:pr-6">
                        <h4 class="font-semibold text-teal-400">Crecimiento y Comportamiento</h4>
                        <div>
                            <label for="adv_initialUsers" class="block font-medium text-sm text-slate-300">Usuarios Iniciales</label>
                            <div class="flex items-center gap-4"><input type="range" id="adv_initialUsers" min="500" max="5000" value="1000" step="100" class="w-full"><span id="adv_initialUsersValue" class="font-bold text-white w-20 text-center"></span></div>
                        </div>
                        <div>
                            <label for="adv_referralRate" class="block font-medium text-sm text-slate-300">Tasa de Referidos Semanal</label>
                            <div class="flex items-center gap-4"><input type="range" id="adv_referralRate" min="1" max="15" value="5" step="0.5" class="w-full"><span id="adv_referralRateValue" class="font-bold text-white w-20 text-center"></span></div>
                        </div>
                        <div>
                            <label for="adv_organicGrowth" class="block font-medium text-sm text-slate-300">Crecimiento Org√°nico Semanal</label>
                            <div class="flex items-center gap-4"><input type="range" id="adv_organicGrowth" min="0" max="5" value="1" step="0.5" class="w-full"><span id="adv_organicGrowthValue" class="font-bold text-white w-20 text-center"></span></div>
                        </div>
                        <div>
                            <label for="adv_churnRate" class="block font-medium text-sm text-slate-300">Tasa de Abandono (Churn) Mensual</label>
                            <div class="flex items-center gap-4"><input type="range" id="adv_churnRate" min="0" max="15" value="5" step="1" class="w-full"><span id="adv_churnRateValue" class="font-bold text-white w-20 text-center"></span></div>
                        </div>
                    </div>
                    <div class="space-y-4 lg:border-r lg:border-slate-700 lg:pr-6">
                        <h4 class="font-semibold text-teal-400">Econom√≠a Interna (AC)</h4>
                        <div>
                            <label for="adv_weeklySpend" class="block font-medium text-sm text-slate-300">Gasto Semanal / Usuario (AC)</label>
                            <div class="flex items-center gap-4"><input type="range" id="adv_weeklySpend" min="10" max="100" value="20" step="5" class="w-full"><span id="adv_weeklySpendValue" class="font-bold text-white w-20 text-center"></span></div>
                        </div>
                        <div>
                            <label for="adv_raffleMargin" class="block font-medium text-sm text-slate-300">Margen Objetivo de Rifas</label>
                             <div class="flex items-center gap-4"><input type="range" id="adv_raffleMargin" min="10" max="90" value="40" step="5" class="w-full"><span id="adv_raffleMarginValue" class="font-bold text-white w-20 text-center"></span></div>
                        </div>
                         <div>
                            <label for="adv_catalogGrowth" class="block font-medium text-sm text-slate-300">Crecimiento del Cat√°logo Mensual</label>
                            <div class="flex items-center gap-4"><input type="range" id="adv_catalogGrowth" min="0" max="50" value="10" step="5" class="w-full"><span id="adv_catalogGrowthValue" class="font-bold text-white w-20 text-center"></span></div>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="font-semibold text-teal-400">Finanzas Reales (CLP)</h4>
                        <div>
                            <label for="adv_marketplaceMargin" class="block font-medium text-sm text-slate-300">Margen del Marketplace</label>
                            <div class="flex items-center gap-4"><input type="range" id="adv_marketplaceMargin" min="10" max="50" value="30" step="1" class="w-full"><span id="adv_marketplaceMarginValue" class="font-bold text-white w-20 text-center"></span></div>
                        </div>
                        <div>
                            <label for="adv_redemptionRate" class="block font-medium text-sm text-slate-300">Tasa de Canje de Premios</label>
                            <div class="flex items-center gap-4"><input type="range" id="adv_redemptionRate" min="50" max="100" value="85" step="1" class="w-full"><span id="adv_redemptionRateValue" class="font-bold text-white w-20 text-center"></span></div>
                        </div>
                        <div>
                            <label for="adv_opex" class="block font-medium text-sm text-slate-300">Costos Operativos Mensuales (CLP)</label>
                            <div class="flex items-center gap-4"><input type="range" id="adv_opex" min="0" max="5000000" value="500000" step="100000" class="w-full"><span id="adv_opexValue" class="font-bold text-white w-28 text-center"></span></div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-8">
                     <button id="adv_run-simulation" class="bg-blue-600 text-white font-bold py-3 px-10 rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105">Ejecutar Simulaci√≥n</button>
                </div>
            </div>

            <div class="bg-slate-900/50 rounded-xl shadow-lg p-4 sm:p-6">
                <div class="border-b border-slate-700 pb-2">
                    <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                        <button class="tab-button active py-3 px-4 font-medium text-sm" data-tab="adv_summary">Resumen Ejecutivo</button>
                        <button class="tab-button text-slate-300 hover:bg-slate-700/50 py-3 px-4 font-medium text-sm" data-tab="adv_banco_central">Diagn√≥stico del Banco Central</button>
                        <button class="tab-button text-slate-300 hover:bg-slate-700/50 py-3 px-4 font-medium text-sm" data-tab="adv_ac_economy">Econom√≠a AC</button>
                        <button class="tab-button text-slate-300 hover:bg-slate-700/50 py-3 px-4 font-medium text-sm" data-tab="adv_finance">Finanzas CLP</button>
                    </nav>
                </div>

                <div class="pt-6">
                    <div id="adv_summary" class="content-pane active"></div>
                    <div id="adv_banco_central" class="content-pane"></div>
                    <div id="adv_ac_economy" class="content-pane"></div>
                    <div id="adv_finance" class="content-pane"></div>
                </div>
            </div>
        </section>
        <!-- === FIN: SIMULADOR DE NEGOCIOS COMPLETO === -->
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- L√ìGICA DEL DIAGRAMA DE FLUJO ---
            const diagramLogic = {
                appData: {
                    emission: { 
                        title: 'Emisi√≥n: C√≥mo se Crean las Monedas', 
                        content: 'La creaci√≥n de AC (emisi√≥n) es el punto de partida. Est√° dise√±ada para ser end√≥gena, es decir, cada nueva moneda se crea como resultado de una acci√≥n que aporta valor directo al negocio, ya sea a trav√©s de ingresos reales o de crecimiento de usuarios.',
                        points: ['<strong>Compra Directa:</strong> Es la fuente primaria y m√°s saludable. Un usuario paga CLP y recibe AC. Esto respalda la econom√≠a con capital real y es el principal generador de ingresos.','<strong>Recompensas por Crecimiento:</strong> Emitir AC por referidos o cashback es una inversi√≥n. En lugar de gastar CLP en marketing, la empresa "imprime" su propia moneda para pagar la adquisici√≥n de nuevos clientes, un costo de marketing controlado y eficiente.'] 
                    },
                    circulation: { 
                        title: 'Circulaci√≥n: El Motor de la Actividad', 
                        content: 'Una vez emitidos, los AC deben circular. El motor principal de esta circulaci√≥n es el gasto de los usuarios en los tickets de las rifas. Este flujo constante es vital para mantener a los usuarios comprometidos y la econom√≠a activa.',
                        points: ['<strong>Gasto en Rifas:</strong> Es el desag√ºe principal y la pieza central del modelo. Los usuarios usan los AC que compraron para participar, retirando esa moneda del circulante y movi√©ndola hacia el pozo de la rifa.','<strong>Pozo de la Rifa (Tesorer√≠a Virtual):</strong> Los AC gastados en tickets se acumulan aqu√≠. Al finalizar la rifa, una parte se entrega como premio (recirculaci√≥n) y la otra es la ganancia de la empresa en AC.','<strong>Recirculaci√≥n de Premios:</strong> Los ganadores reciben sus premios en AC, reinyectando una cantidad controlada de moneda en el sistema, lo que les permite participar en el siguiente paso: la absorci√≥n.'] 
                    },
                    control: { 
                        title: 'Absorci√≥n: El Sumidero Final de Valor', 
                        content: 'La absorci√≥n es el proceso de retirar permanentemente los AC del ecosistema. Esto es crucial para controlar la inflaci√≥n y dar un prop√≥sito final a la moneda. Se logra principalmente a trav√©s del gasto de los premios en el marketplace.',
                        points: ['<strong>Marketplace como Sumidero:</strong> Es el mecanismo final. Los ganadores usan sus AC para "comprar" productos. Una vez gastados aqu√≠, esos AC son absorbidos por la empresa y salen de circulaci√≥n para siempre.','<strong>Finanzas Reales y Costos:</strong> Por cada producto canjeado, la empresa tiene un costo real en CLP que debe pagar al proveedor de dropshipping. La diferencia entre el valor del producto en AC y este costo real es el margen de ganancia final del ciclo.','<strong>Bienes Virtuales (Absorci√≥n Pura):</strong> Vender √≠tems cosm√©ticos o de estatus por AC es una forma de absorci√≥n sin costo real, lo que representa un 100% de margen y una poderosa herramienta de control econ√≥mico.'] 
                    }
                },
                detailPanel: document.getElementById('detail-panel'),
                diagramNodes: document.querySelectorAll('.diagram-node'),
                init() {
                    this.diagramNodes.forEach(node => node.addEventListener('click', (e) => this.handleNodeClick(e)));
                    const firstNode = this.diagramNodes[0];
                    if (firstNode) {
                        firstNode.classList.add('active');
                        this.updateDetailPanel(firstNode.dataset.target);
                    }
                },
                updateDetailPanel(targetId) {
                    const data = this.appData[targetId];
                    if (!data) return;
                    const pointsHTML = data.points ? `<ul class="space-y-3 list-inside mt-4">${data.points.map(p => `<li class="flex items-start"><span class="text-teal-500 mr-2 mt-1">‚ñ∏</span><span>${p}</span></li>`).join('')}</ul>` : '';
                    this.detailPanel.innerHTML = `<div class="detail-panel-content"><h2 class="text-2xl font-bold text-gray-800 mb-2">${data.title}</h2><p class="text-gray-600 leading-relaxed">${data.content}</p>${pointsHTML}</div>`;
                },
                handleNodeClick(event) {
                    const targetId = event.currentTarget.dataset.target;
                    this.diagramNodes.forEach(node => node.classList.remove('active'));
                    event.currentTarget.classList.add('active');
                    this.updateDetailPanel(targetId);
                }
            };
            diagramLogic.init();

            // --- L√ìGICA DEL SIMULADOR DE NEGOCIOS COMPLETO ---
            const businessSimulator = {
                sliders: {
                    initialUsers: document.getElementById('adv_initialUsers'), referralRate: document.getElementById('adv_referralRate'), organicGrowth: document.getElementById('adv_organicGrowth'), churnRate: document.getElementById('adv_churnRate'),
                    weeklySpend: document.getElementById('adv_weeklySpend'), raffleMargin: document.getElementById('adv_raffleMargin'), catalogGrowth: document.getElementById('adv_catalogGrowth'),
                    marketplaceMargin: document.getElementById('adv_marketplaceMargin'), redemptionRate: document.getElementById('adv_redemptionRate'), opex: document.getElementById('adv_opex')
                },
                values: {
                    initialUsers: document.getElementById('adv_initialUsersValue'), referralRate: document.getElementById('adv_referralRateValue'), organicGrowth: document.getElementById('adv_organicGrowthValue'), churnRate: document.getElementById('adv_churnRateValue'),
                    weeklySpend: document.getElementById('adv_weeklySpendValue'), raffleMargin: document.getElementById('adv_raffleMarginValue'), catalogGrowth: document.getElementById('adv_catalogGrowthValue'),
                    marketplaceMargin: document.getElementById('adv_marketplaceMarginValue'), redemptionRate: document.getElementById('adv_redemptionRateValue'), opex: document.getElementById('adv_opexValue')
                },
                runButton: document.getElementById('adv_run-simulation'),
                acChart: null,
                financeChart: null,

                init() {
                    this.setupTabs();
                    Object.keys(this.sliders).forEach(key => {
                        if (this.sliders[key]) {
                            this.sliders[key].addEventListener('input', () => this.updateSliderValues());
                        }
                    });
                    this.runButton.addEventListener('click', () => this.run());
                    this.updateSliderValues();
                    this.run();
                },
                
                formatNumber(num, prefix = '', suffix = '') {
                    return `${prefix}${new Intl.NumberFormat('es-CL').format(Math.round(num))}${suffix}`;
                },
                
                updateSliderValues() {
                    this.values.initialUsers.textContent = this.formatNumber(this.sliders.initialUsers.value);
                    this.values.referralRate.textContent = `${this.sliders.referralRate.value}%`;
                    this.values.organicGrowth.textContent = `${this.sliders.organicGrowth.value}%`;
                    this.values.churnRate.textContent = `${this.sliders.churnRate.value}%`;
                    this.values.weeklySpend.textContent = `${this.sliders.weeklySpend.value} AC`;
                    this.values.raffleMargin.textContent = `${this.sliders.raffleMargin.value}%`;
                    this.values.catalogGrowth.textContent = `${this.sliders.catalogGrowth.value}%`;
                    this.values.marketplaceMargin.textContent = `${this.sliders.marketplaceMargin.value}%`;
                    this.values.redemptionRate.textContent = `${this.sliders.redemptionRate.value}%`;
                    this.values.opex.textContent = this.formatNumber(this.sliders.opex.value, '$');
                },

                run() {
                    const P = {
                        initialUsers: parseInt(this.sliders.initialUsers.value),
                        referralRate: parseFloat(this.sliders.referralRate.value) / 100,
                        organicGrowthRate: parseFloat(this.sliders.organicGrowth.value) / 100,
                        churnRate: parseFloat(this.sliders.churnRate.value) / 100,
                        weeklySpendAC: parseInt(this.sliders.weeklySpend.value),
                        raffleMargin: parseFloat(this.sliders.raffleMargin.value) / 100,
                        redemptionRate: parseFloat(this.sliders.redemptionRate.value) / 100,
                        marketplaceMargin: parseFloat(this.sliders.marketplaceMargin.value) / 100,
                        opexCLP: parseInt(this.sliders.opex.value),
                        acToCLP: 100,
                        cashbackRate: 0.30,
                        simulationWeeks: 52,
                    };

                    let weeklyData = [];
                    let currentUsers = P.initialUsers;
                    
                    for (let week = 1; week <= P.simulationWeeks; week++) {
                        if (week > 1 && (week - 1) % 4 === 0) {
                            currentUsers -= currentUsers * P.churnRate;
                        }
                        const activeUsers = currentUsers;
                        
                        const referredNewUsers = activeUsers * P.referralRate;
                        const organicNewUsers = activeUsers * P.organicGrowthRate;
                        
                        const emission_purchases = activeUsers * P.weeklySpendAC;
                        const emission_referrals = referredNewUsers * 10;
                        const emission_cashback = (referredNewUsers * P.weeklySpendAC) * P.cashbackRate;
                        const total_emission = emission_purchases + emission_referrals + emission_cashback;

                        const total_spent_in_raffles = activeUsers * P.weeklySpendAC;
                        const total_prize_pool_AC = total_spent_in_raffles * (1 - P.raffleMargin);
                        const prizes_awarded_AC = total_prize_pool_AC;

                        const redeemed_prizes_AC = prizes_awarded_AC * P.redemptionRate;
                        const total_absorption = redeemed_prizes_AC;

                        const incomeCLP = emission_purchases * P.acToCLP;
                        const cogsCLP = redeemed_prizes_AC * P.acToCLP * (1 - P.marketplaceMargin);
                        
                        weeklyData.push({
                            users: currentUsers,
                            total_emission,
                            total_spent_in_raffles,
                            prizes_awarded_AC,
                            total_absorption,
                            incomeCLP,
                            cogsCLP
                        });
                        
                        currentUsers += (referredNewUsers + organicNewUsers);
                    }
                    
                    let monthlyResults = [], circulatingAC = 0, lastMonthCirculatingAC = 0, treasuryCLP = 0;
                    
                    for (let m = 1; m <= 12; m++) {
                        const monthWeeks = weeklyData.slice((m - 1) * 4, m * 4);
                        if (monthWeeks.length === 0) continue;

                        const monthEndUsers = monthWeeks[monthWeeks.length - 1].users;
                        const monthEmission = monthWeeks.reduce((s, w) => s + w.total_emission, 0);
                        const monthSpentInRaffles = monthWeeks.reduce((s, w) => s + w.total_spent_in_raffles, 0);
                        const monthPrizesAwarded = monthWeeks.reduce((s,w) => s+w.prizes_awarded_AC, 0);
                        const monthAbsorption = monthWeeks.reduce((s, w) => s + w.total_absorption, 0);
                        
                        circulatingAC += monthEmission - monthSpentInRaffles + monthPrizesAwarded - monthAbsorption;
                        circulatingAC = Math.max(0, circulatingAC);

                        const inflation = lastMonthCirculatingAC > 0 ? ((circulatingAC - lastMonthCirculatingAC) / lastMonthCirculatingAC) * 100 : 0;
                        
                        const monthIncomeCLP = monthWeeks.reduce((s, w) => s + w.incomeCLP, 0);
                        const monthCogsCLP = monthWeeks.reduce((s, w) => s + w.cogsCLP, 0);
                        const monthCostsCLP = monthCogsCLP + P.opexCLP;
                        const monthNetProfitCLP = monthIncomeCLP - monthCostsCLP;
                        treasuryCLP += monthNetProfitCLP;
                        
                        monthlyResults.push({
                            month: m, users: monthEndUsers, emitted: monthEmission, spent: monthSpentInRaffles, awarded: monthPrizesAwarded, absorbed: monthAbsorption,
                            circulating: circulatingAC, inflation, 
                            incomeCLP: monthIncomeCLP, costsCLP: monthCostsCLP, netProfitCLP: monthNetProfitCLP, treasuryCLP,
                        });
                        
                        lastMonthCirculatingAC = circulatingAC;
                    }
                    
                    this.updateUI(monthlyResults);
                },

                updateUI(results) {
                    this.updateSummary(results);
                    this.updateBancoCentral(results);
                    this.updateAcEconomy(results);
                    this.updateFinance(results);
                },
                
                updateSummary(results) {
                    const final = results[results.length - 1];
                    const inflationAlerts = results.filter(r => r.inflation > 50);
                    const cashflowAlerts = results.filter(r => r.netProfitCLP < 0);
                    
                    let html = `<div class="p-4 bg-slate-800/50 rounded-lg"><h4 class="font-semibold text-slate-200">Resultados Clave (Mes 12)</h4><div class="mt-2 grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                        <p><strong>Usuarios:</strong> ${this.formatNumber(final.users)}</p>
                        <p><strong>AC Circulantes:</strong> ${this.formatNumber(final.circulating)}</p>
                        <p><strong>Ganancia Neta Mensual:</strong> <span class="${final.netProfitCLP < 0 ? 'text-red-400' : 'text-green-400'}">${this.formatNumber(final.netProfitCLP, '$')}</span></p>
                        <p><strong>Tesorer√≠a Acumulada:</strong> <span class="${final.treasuryCLP < 0 ? 'text-red-400' : 'text-green-400'}">${this.formatNumber(final.treasuryCLP, '$')}</span></p>
                    </div></div>`;
                    
                    if (inflationAlerts.length > 0) {
                        html += `<div class="mt-4 p-4 bg-amber-900/50 border-l-4 border-amber-500 rounded-r-lg"><h4 class="font-semibold text-amber-300">‚ö†Ô∏è Alerta de Inflaci√≥n</h4><p class="text-sm text-amber-400 mt-1">La masa monetaria creci√≥ sobre 50% en los meses: <strong>${inflationAlerts.map(a => a.month).join(', ')}</strong>. El motor de crecimiento es muy agresivo.</p></div>`;
                    }
                    if (cashflowAlerts.length > 0) {
                        html += `<div class="mt-4 p-4 bg-red-900/50 border-l-4 border-red-500 rounded-r-lg"><h4 class="font-semibold text-red-300">üö® Alerta de Flujo de Caja Negativo</h4><p class="text-sm text-red-400 mt-1">El negocio pierde dinero real en los meses: <strong>${cashflowAlerts.map(a => a.month).join(', ')}</strong>. Revisar margen del marketplace y costos operativos.</p></div>`;
                    }
                    if (inflationAlerts.length === 0 && cashflowAlerts.length === 0) {
                         html += `<div class="mt-4 p-4 bg-green-900/50 border-l-4 border-green-500 rounded-r-lg"><h4 class="font-semibold text-green-300">‚úÖ Modelo de Negocio Sostenible</h4><p class="text-sm text-green-400 mt-1">Bajo los par√°metros actuales, la econom√≠a virtual y las finanzas reales son estables y rentables.</p></div>`;
                    }
                    
                    document.getElementById('adv_summary').innerHTML = html;
                },

                updateBancoCentral(results){
                    const pane = document.getElementById('adv_banco_central');
                    pane.innerHTML = `<h3 class="text-lg font-semibold mb-4 text-white">Diagn√≥stico del Banco Central</h3><div class="p-4 bg-green-900/50 border-l-4 border-green-500 rounded-r-lg"><h4 class="font-semibold text-green-300">‚úÖ Sistema Estable</h4><p class="text-sm text-green-400 mt-1">No se requirieron intervenciones autom√°ticas en este modelo. La econom√≠a oper√≥ dentro de los rangos de seguridad establecidos.</p></div>`;
                },
                
                updateAcEconomy(results) {
                    const pane = document.getElementById('adv_ac_economy');
                    let canvas = pane.querySelector('canvas');
                    let tableBody = pane.querySelector('tbody');

                    if (!tableBody) {
                        pane.innerHTML = `<h3 class="text-lg font-semibold mb-4 text-white">Evoluci√≥n de la Econom√≠a Virtual (AC)</h3><div class="grid grid-cols-1 xl:grid-cols-2 gap-8"><div class="overflow-x-auto"><table class="min-w-full divide-y divide-slate-700"><thead class="bg-slate-800/50"><tr><th class="px-3 py-2 text-left text-xs font-medium text-slate-400">Mes</th><th class="px-3 py-2 text-left text-xs font-medium text-slate-400">Emitidos</th><th class="px-3 py-2 text-left text-xs font-medium text-slate-400">Gastados (Rifas)</th><th class="px-3 py-2 text-left text-xs font-medium text-slate-400">Recirculados (Premios)</th><th class="px-3 py-2 text-left text-xs font-medium text-slate-400">Absorbidos (Market)</th><th class="px-3 py-2 text-left text-xs font-medium text-slate-400">Circulante Final</th></tr></thead><tbody class="bg-slate-900/30 divide-y divide-slate-800"></tbody></table></div><div class="chart-container-economy"><canvas id="adv_ac_chart"></canvas></div></div>`;
                        canvas = document.getElementById('adv_ac_chart');
                        tableBody = pane.querySelector('tbody');
                    }
                    
                    tableBody.innerHTML = '';
                    results.forEach(res => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-3 py-2 text-sm font-medium text-white">${res.month}</td>
                            <td class="px-3 py-2 text-sm text-green-400">+${this.formatNumber(res.emitted)}</td>
                            <td class="px-3 py-2 text-sm text-red-400">-${this.formatNumber(res.spent)}</td>
                            <td class="px-3 py-2 text-sm text-blue-400">+${this.formatNumber(res.awarded)}</td>
                            <td class="px-3 py-2 text-sm text-amber-400">-${this.formatNumber(res.absorbed)}</td>
                            <td class="px-3 py-2 text-sm font-semibold text-white">${this.formatNumber(res.circulating)}</td>`;
                        tableBody.appendChild(row);
                    });

                    const data = {
                        labels: results.map(r => `Mes ${r.month}`),
                        datasets: [
                            { label: 'AC Circulantes', data: results.map(r => r.circulating), borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.2, yAxisID: 'y', fill: true, type: 'line' },
                            { label: 'AC Gastados en Rifas', data: results.map(r => r.spent), backgroundColor: 'rgba(239, 68, 68, 0.7)', yAxisID: 'y1', type: 'bar' },
                            { label: 'AC Recirculados (Premios)', data: results.map(r => r.awarded), backgroundColor: 'rgba(59, 130, 246, 0.7)', yAxisID: 'y1', type: 'bar' },
                        ]
                    };
                    if (this.acChart) { this.acChart.data = data; this.acChart.update(); }
                    else {
                        this.acChart = new Chart(canvas.getContext('2d'), {
                            type: 'bar', data,
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                scales: {
                                    y: { type: 'linear', position: 'left', title: { display: true, text: 'Total AC Circulantes', color: '#9ca3af' }, ticks: { color: '#9ca3af' } },
                                    y1: { type: 'linear', position: 'right', title: { display: true, text: 'Flujo Mensual de AC', color: '#9ca3af' }, grid: { drawOnChartArea: false }, ticks: { color: '#9ca3af' } }
                                },
                                plugins: { legend: { labels: { color: '#cbd5e1' } }, tooltip: { mode: 'index', intersect: false, callbacks: { label: (c) => `${c.dataset.label}: ${this.formatNumber(c.parsed.y)}` } } }
                            }
                        });
                    }
                },

                updateFinance(results) {
                    const pane = document.getElementById('adv_finance');
                    let canvas = pane.querySelector('canvas');
                     if (!canvas) {
                        pane.innerHTML = `
                            <h3 class="text-lg font-semibold mb-4 text-white">An√°lisis Financiero (CLP)</h3>
                            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-slate-700"><thead class="bg-slate-800/50"><tr>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-slate-400">Mes</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-slate-400">Ingresos</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-slate-400">Costos</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-slate-400">Ganancia Neta</th>
                                        <th class="px-3 py-2 text-left text-xs font-medium text-slate-400">Tesorer√≠a</th>
                                    </tr></thead><tbody class="bg-slate-900/30 divide-y divide-slate-800"></tbody></table>
                                </div>
                                <div class="chart-container-economy"><canvas id="finance-chart"></canvas></div>
                            </div>`;
                        canvas = document.getElementById('finance-chart');
                    }
                    const tableBody = pane.querySelector('tbody');
                    tableBody.innerHTML = '';
                    results.forEach(res => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-3 py-2 text-sm text-white">${res.month}</td>
                            <td class="px-3 py-2 text-sm text-green-400">${this.formatNumber(res.incomeCLP, '$')}</td>
                            <td class="px-3 py-2 text-sm text-amber-400">${this.formatNumber(res.costsCLP, '$')}</td>
                            <td class="px-3 py-2 text-sm font-bold ${res.netProfitCLP < 0 ? 'text-red-400' : 'text-green-400'}">${this.formatNumber(res.netProfitCLP, '$')}</td>
                            <td class="px-3 py-2 text-sm font-semibold ${res.treasuryCLP < 0 ? 'text-red-400' : 'text-white'}">${this.formatNumber(res.treasuryCLP, '$')}</td>`;
                        tableBody.appendChild(row);
                    });
                    const data = {
                        labels: results.map(r => `Mes ${r.month}`),
                        datasets: [
                            { type: 'bar', label: 'Ingresos CLP', data: results.map(r => r.incomeCLP), backgroundColor: 'rgba(34, 197, 94, 0.7)', yAxisID: 'y' },
                            { type: 'bar', label: 'Costos CLP', data: results.map(r => r.costsCLP), backgroundColor: 'rgba(249, 115, 22, 0.7)', yAxisID: 'y' },
                            { type: 'line', label: 'Tesorer√≠a CLP', data: results.map(r => r.treasuryCLP), borderColor: '#60a5fa', tension: 0.2, yAxisID: 'y1', fill: false, borderWidth: 3 }
                        ]
                    };
                    if (this.financeChart) { this.financeChart.data = data; this.financeChart.update(); }
                    else {
                         this.financeChart = new Chart(canvas.getContext('2d'), {
                            type: 'bar', data: data,
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                scales: {
                                    x: { ticks: { color: '#9ca3af' } },
                                    y: { type: 'linear', position: 'left', title: { display: true, text: 'Flujo Mensual (CLP)', color: '#9ca3af' }, ticks: { color: '#9ca3af' } },
                                    y1: { type: 'linear', position: 'right', title: { display: true, text: 'Tesorer√≠a Acumulada (CLP)', color: '#9ca3af' }, grid: { drawOnChartArea: false }, ticks: { color: '#9ca3af' } }
                                },
                                plugins: { legend: { labels: { color: '#cbd5e1' } }, tooltip: { mode: 'index', intersect: false, callbacks: { label: (c) => `${c.dataset.label}: ${this.formatNumber(c.parsed.y, '$', ' CLP')}` } } }
                            }
                        });
                    }
                },
                
                setupTabs() {
                    const advTabs = document.querySelectorAll('#advanced_simulator_section .tab-button');
                    const advPanes = document.querySelectorAll('#advanced_simulator_section .content-pane');
                    advTabs.forEach(tab => {
                        tab.addEventListener('click', () => {
                            advTabs.forEach(t => t.classList.remove('active'));
                            advPanes.forEach(p => p.classList.remove('active'));
                            tab.classList.add('active');
                            document.getElementById(tab.dataset.tab).classList.add('active');
                        });
                    });
                }
            };
            businessSimulator.init();
        });
    </script>
</body>
</html>
